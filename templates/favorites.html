{% extends "base.html" %}

{% block title %}DailyMood — Favorites{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-6 py-16">
  <section class="theme-panel card p-8">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-4 dark:text-gray-100" data-i18n="favorites_title">Обрані поради</h1>
    <p class="text-gray-600 dark:text-gray-300 mb-6" data-i18n="favorites_description">
      Ваші збережені поради зберігаються локально у вашому браузері. Керуйте своєю колекцією: копіюйте, видаляйте або повертайтесь на головну за новими порадами.
    </p>

    <div id="favoritesList" class="space-y-4">
      <!-- favorites will be injected here by JS -->
    </div>

    <div class="panel-actions" style="margin-top:18px;">
      <button id="clearFavorites" class="btn secondary" data-i18n="clear_all">Очистити все</button>
      <a href="/" class="btn" data-i18n="nav_home">На головну</a>
    </div>
  </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // LocalStorage-based favorites UI
  (function(){
    const storageKey = 'dailyMoodFavorites';
    const listEl = document.getElementById('favoritesList');
    const clearBtn = document.getElementById('clearFavorites');

    function loadFavorites(){
      try {
        const raw = JSON.parse(localStorage.getItem(storageKey) || '[]');
        // Normalize old-format string entries to objects { text, favorite }
        if (!Array.isArray(raw)) return [];
        return raw.map(item => {
          if (typeof item === 'string') return { text: item, favorite: false };
          if (item && typeof item === 'object' && 'text' in item) return { text: String(item.text), favorite: !!item.favorite };
          return null;
        }).filter(Boolean);
      } catch(e) { return []; }
    }

    function saveFavorites(arr){
      try { localStorage.setItem(storageKey, JSON.stringify(arr)); } catch(e){}
    }

    function getI18nText(key) {
      return currentLanguage === 'uk' ? translations_uk[key] : translations_en[key];
    }

    function render(){
      const items = loadFavorites();
      listEl.innerHTML = '';
      if (items.length === 0) {
        listEl.innerHTML = `<div class="muted">${getI18nText('no_favorites')}</div>`;
        return;
      }
      items.forEach((item, i) => {
        const card = document.createElement('div');
        card.className = 'card fav-item';

        const favClass = item.favorite ? 'favorited' : '';
        // Use data-i18n attributes for dynamic content
        const heartChar = item.favorite ? '♥' : '♡';
        card.innerHTML = `
          <div class="fav-row">
            <div class="fav-text">
              <div class="fav-quote">${escapeHtml(item.text)}</div>
            </div>
            <div class="fav-actions">
              <button class="heart-btn ${favClass}" aria-pressed="${item.favorite}" data-fav-index="${i}" title="${getI18nText('toggle_favorite') || 'Toggle favorite'}">${heartChar}</button>
              <button class="btn" data-copy-index="${i}" data-i18n="copy_quote">Копіювати</button>
              <button class="btn secondary" data-remove-index="${i}" data-i18n="delete">Видалити</button>
            </div>
          </div>
        `;

        listEl.appendChild(card);
      });

      // Re-apply translations after rendering
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        const translation = currentLanguage === 'uk' ? translations_uk[key] : translations_en[key];
        if (translation) {
          element.textContent = translation;
        }
      });
    }

    function escapeHtml(str){ 
      return String(str).replace(/[&<>\"]/g, function(c){ 
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]; 
      }); 
    }

    // Delegated handlers
    listEl.addEventListener('click', function(e){
      const copyIndex = e.target.getAttribute('data-copy-index');
      if (copyIndex !== null) {
        const items = loadFavorites();
        navigator.clipboard.writeText(items[copyIndex])
          .then(()=>{ 
            const originalText = e.target.textContent;
            e.target.textContent = getI18nText('copied'); 
            setTimeout(()=> e.target.textContent = originalText, 900); 
          })
          .catch(()=>{});
        return;
      }
      const favIndex = e.target.getAttribute('data-fav-index');
      if (favIndex !== null) {
        const items = loadFavorites();
        const idx = parseInt(favIndex, 10);
        if (!items[idx]) return;
        // Toggle favorite flag only (do not delete the saved quote). Use remove button to delete.
        items[idx].favorite = !items[idx].favorite;
        saveFavorites(items);
        render();
        try { window.dispatchEvent(new Event('favoritesUpdated')); } catch(e){}
        return;
      }
      const removeIndex = e.target.getAttribute('data-remove-index');
      if (removeIndex !== null){ 
        const items = loadFavorites(); 
        const idx = parseInt(removeIndex, 10);
        const btnEl = e.target;
        const cardEl = btnEl.closest('.fav-item');
        if (cardEl) cardEl.classList.add('fav-removing');
        setTimeout(() => {
          items.splice(idx,1); 
          saveFavorites(items); 
          render(); 
          try { window.dispatchEvent(new Event('favoritesUpdated')); } catch(e){}
        }, 260);
        return; 
      }
    });

    clearBtn.addEventListener('click', function(){ 
      if (!confirm(getI18nText('confirm_clear_all'))) return; 
      saveFavorites([]); 
      render(); 
      try { window.dispatchEvent(new Event('favoritesUpdated')); } catch(e){}
    });

    // Listen for language changes
    window.addEventListener('languageChanged', render);

    render();
  })();
</script>
{% endblock %}