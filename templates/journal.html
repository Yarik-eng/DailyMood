{% extends "base.html" %}

{% block title %}–©–æ–¥–µ–Ω–Ω–∏–∫ - DailyMood{% endblock %}

{% block content %}

    <main class="journal-container">
        <h1 data-i18n="journal_title">–ú—ñ–π —â–æ–¥–µ–Ω–Ω–∏–∫ –Ω–∞—Å—Ç—Ä–æ—é</h1>
        
    <section class="new-entry">
            <h2 data-i18n="new_entry">–ù–æ–≤–∏–π –∑–∞–ø–∏—Å</h2>
            <form id="journalForm" class="journal-form">
                <div class="form-group">
                    <label for="mood"><span data-i18n="mood">–ù–∞—Å—Ç—Ä—ñ–π:</span></label>
                    <select name="mood" id="mood" required>
                        <option value="happy" data-i18n="mood_happy">üòä –©–∞—Å–ª–∏–≤–∏–π</option>
                        <option value="excited" data-i18n="mood_excited">ü§© –ó–±—É–¥–∂–µ–Ω–∏–π</option>
                        <option value="neutral" data-i18n="mood_neutral">üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–∏–π</option>
                        <option value="calm" data-i18n="mood_calm">üòå –°–ø–æ–∫—ñ–π–Ω–∏–π</option>
                        <option value="angry" data-i18n="mood_angry">üò† –°–µ—Ä–¥–∏—Ç–∏–π</option>
                        <option value="sad" data-i18n="mood_sad">üò¢ –°—É–º–Ω–∏–π</option>
                        <option value="disappointed" data-i18n="mood_disappointed">üòî –†–æ–∑—á–∞—Ä–æ–≤–∞–Ω–∏–π</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="date"><span data-i18n="date">–î–∞—Ç–∞:</span></label>
                    <input type="date" id="date" name="date" required>
                </div>

                <div class="form-group">
                    <label for="title"><span data-i18n="entry_title">–ó–∞–≥–æ–ª–æ–≤–æ–∫:</span></label>
                    <input type="text" id="title" name="title" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –ø—Ä–æ –¥–µ–Ω—å" data-i18n="title_placeholder" required>
                </div>

                <div class="form-group">
                    <label for="content"><span data-i18n="content">–û–ø–∏—Å –¥–Ω—è:</span></label>
                    <textarea id="content" name="content" rows="5" 
                              placeholder="–©–æ —Å—Ç–∞–ª–æ—Å—è —Å—å–æ–≥–æ–¥–Ω—ñ? –©–æ –≤–ø–ª–∏–Ω—É–ª–æ –Ω–∞ –≤–∞—à –Ω–∞—Å—Ç—Ä—ñ–π?" data-i18n="content_placeholder"></textarea>
                </div>

                <div class="form-group">
                    <label for="sleep_quality" style="display: flex; justify-content: space-between; align-items: center;">
                        <span data-i18n="sleep_quality">–Ø–∫—ñ—Å—Ç—å —Å–Ω—É:</span>
                        <span id="sleepQualityLabel" style="font-size: 20px;">üòê</span>
                    </label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>üò¥</span>
                        <input type="range" id="sleep_quality" name="sleep_quality" min="1" max="4" value="2" class="sleep-slider">
                        <span>üò¥‚ú®</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 14px; font-weight: 600; color: inherit; margin-top: 8px; opacity: 0.85;">
                        <span data-i18n="sleep_terrible">–ñ–∞—Ö–ª–∏–≤–æ</span>
                        <span data-i18n="sleep_bad">–ü–æ–≥–∞–Ω–æ</span>
                        <span data-i18n="sleep_good">–î–æ–±—Ä–µ</span>
                        <span data-i18n="sleep_excellent">–°—É–ø–µ—Ä</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="sleep_hours" style="display: flex; justify-content: space-between; align-items: center;">
                        <span data-i18n="sleep_hours">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω —Å–Ω—É:</span>
                        <span id="sleepHoursLabel" style="font-weight: 700; color: var(--profile-accent);">7 –≥–æ–¥</span>
                    </label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>0</span>
                        <input type="range" id="sleep_hours" name="sleep_hours" min="0" max="12" value="7" step="0.5" class="sleep-hours-slider" style="flex: 1;">
                        <span>12</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="activities"><span data-i18n="activities">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ:</span></label>
                    <div class="activities-grid">
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="exercise">
                            <span data-i18n="activity_exercise">üèÉ‚Äç‚ôÇÔ∏è –°–ø–æ—Ä—Ç</span>
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="meditation">
                            <span data-i18n="activity_meditation">üßò‚Äç‚ôÇÔ∏è –ú–µ–¥–∏—Ç–∞—Ü—ñ—è</span>
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="reading">
                            <span data-i18n="activity_reading">üìö –ß–∏—Ç–∞–Ω–Ω—è</span>
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="social">
                            <span data-i18n="activity_social">üë• –°–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è</span>
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="nature">
                            <span data-i18n="activity_nature">üå≥ –ü—Ä–∏—Ä–æ–¥–∞</span>
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="work">
                            <span data-i18n="activity_work">üíº –†–æ–±–æ—Ç–∞</span>
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="games">
                            <span data-i18n="activity_games">üéÆ –Ü–≥—Ä–∏</span>
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="music">
                            <span data-i18n="activity_music">üéµ –ú—É–∑–∏–∫–∞</span>
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="creativity">
                            <span data-i18n="activity_creativity">üé® –¢–≤–æ—Ä—á—ñ—Å—Ç—å</span>
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="cooking">
                            <span data-i18n="activity_cooking">üçî –ì–æ—Ç—É–≤–∞–Ω–Ω—è</span>
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="sleep">
                            <span data-i18n="activity_sleep">üí§ –°–æ–Ω</span>
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="movies">
                            <span data-i18n="activity_movies">üé¨ –ö—ñ–Ω–æ/–¢–í</span>
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="social_media">
                            <span data-i18n="activity_social_media">üì± –°–æ—Ü—ñ–∞–ª—å–Ω—ñ –º–µ—Ä–µ–∂—ñ</span>
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="shopping">
                            <span data-i18n="activity_shopping">üõçÔ∏è –®–æ–ø—ñ–Ω–≥</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="btn-primary" data-i18n="save_entry">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–∞–ø–∏—Å</button>
            </form>
        </section>

    <section class="entries-list">
            <h2 data-i18n="my_entries">–ú–æ—ó –∑–∞–ø–∏—Å–∏</h2>
            <div class="entries-filter">
                <input type="month" id="monthFilter">
                <select id="moodFilter">
                    <option value="" data-i18n="all_moods">–í—Å—ñ –Ω–∞—Å—Ç—Ä–æ—ó</option>
                    <option value="happy" data-i18n="mood_happy">üòä –©–∞—Å–ª–∏–≤–∏–π</option>
                    <option value="excited" data-i18n="mood_excited">ü§© –ó–±—É–¥–∂–µ–Ω–∏–π</option>
                    <option value="neutral" data-i18n="mood_neutral">üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–∏–π</option>
                    <option value="calm" data-i18n="mood_calm">üòå –°–ø–æ–∫—ñ–π–Ω–∏–π</option>
                    <option value="angry" data-i18n="mood_angry">üò† –°–µ—Ä–¥–∏—Ç–∏–π</option>
                    <option value="sad" data-i18n="mood_sad">üò¢ –°—É–º–Ω–∏–π</option>
                    <option value="disappointed" data-i18n="mood_disappointed">üòî –†–æ–∑—á–∞—Ä–æ–≤–∞–Ω–∏–π</option>
                </select>
            </div>
            
            <div class="journal-entries" id="entriesList">
                <!-- –ó–∞–ø–∏—Å–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </section>
    </main>

{% endblock %}

{% block extra_scripts %}
<script>
    // –ü—Ä–æ—Å—Ç–∏–π i18n-—Ö–µ–ª–ø–µ—Ä –¥–ª—è —Ü—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    function t(key) {
        try {
            return (typeof currentLanguage !== 'undefined' && currentLanguage === 'uk') ? (translations_uk[key] || '') : (translations_en[key] || '');
        } catch (e) { return ''; }
    }

    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—é –¥–∞—Ç—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
    document.getElementById('date').valueAsDate = new Date();

    function formatDateForLang(iso) {
        try {
            const d = new Date(iso);
            const locale = (typeof currentLanguage !== 'undefined' && currentLanguage === 'en') ? 'en-US' : 'uk-UA';
            return d.toLocaleDateString(locale);
        } catch (e) { return iso; }
    }

    // –Ø–∫—ñ—Å—Ç—å —Å–Ω—É –ø–æ–ª–∑—É–Ω–æ–∫
    const sleepSlider = document.getElementById('sleep_quality');
    const sleepLabel = document.getElementById('sleepQualityLabel');
    const sleepEmojis = ['üò¥', 'üòê', 'üòä', 'üò¥‚ú®'];
    
    sleepSlider.addEventListener('input', (e) => {
        sleepLabel.style.animation = 'none';
        setTimeout(() => {
            sleepLabel.textContent = sleepEmojis[e.target.value - 1];
            sleepLabel.style.animation = 'emojiPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
        }, 10);
    });

    // –ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω —Å–Ω—É –ø–æ–ª–∑—É–Ω–æ–∫
    const sleepHoursSlider = document.getElementById('sleep_hours');
    const sleepHoursLabel = document.getElementById('sleepHoursLabel');
    
    sleepHoursSlider.addEventListener('input', (e) => {
        const hours = parseFloat(e.target.value);
        sleepHoursLabel.textContent = hours.toFixed(1) + ' –≥–æ–¥';
    });

    // –û–±—Ä–æ–±–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º–∏
    document.getElementById('journalForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const activities = Array.from(formData.getAll('activities'));
        
        const entry = {
            mood: formData.get('mood'),
            date: formData.get('date'),
            title: formData.get('title'),
            content: formData.get('content'),
            sleep_quality: formData.get('sleep_quality'),
            sleep_hours: parseFloat(formData.get('sleep_hours')),
            activities: activities
        };

        try {
            const response = await fetch('/api/journal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(entry)
            });

            if (response.ok) {
                alert(t('entry_saved') || '–ó–∞–ø–∏—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
                loadEntries(); // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å—ñ–≤
                e.target.reset();
                document.getElementById('date').valueAsDate = new Date();
            } else {
                alert(t('save_error') || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –∑–∞–ø–∏—Å—É');
            }
        } catch (error) {
            console.error('Error:', error);
            alert(t('save_error') || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –∑–∞–ø–∏—Å—É');
        }
    });

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–ø–∏—Å—ñ–≤
    async function loadEntries() {
        const monthFilter = document.getElementById('monthFilter').value;
        const moodFilter = document.getElementById('moodFilter').value;
        
        try {
            const response = await fetch(`/api/journal?month=${monthFilter}&mood=${moodFilter}`);
            if (!response.ok) {
                console.error('Failed to load entries', response.status);
                return;
            }
            const entries = await response.json();

            const entriesList = document.getElementById('entriesList');
            const sleepQualityLabels = {1: '–ñ–∞—Ö–ª–∏–≤–æ', 2: '–ü–æ–≥–∞–Ω–æ', 3: '–î–æ–±—Ä–µ', 4: '–°—É–ø–µ—Ä'};
            
            entriesList.innerHTML = entries.map(entry => `
                <article class="journal-entry mood-${entry.mood}" data-id="${entry.id}">
                    <header>
                        <div class="entry-header-left">
                            <h3>${entry.title}</h3>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <time datetime="${entry.date}">${formatDateForLang(entry.date)}</time>
                                ${entry.sleep_quality ? `<span style="font-size: 13px; opacity: 0.8;">üí§ ${sleepQualityLabels[entry.sleep_quality] || 'N/A'}</span>` : ''}
                            </div>
                        </div>
                        <div class="entry-header-right">
                            <button class="btn-link delete-entry" data-id="${entry.id}" title="${t('delete') || '–í–∏–¥–∞–ª–∏—Ç–∏'}">${t('delete') || '–í–∏–¥–∞–ª–∏—Ç–∏'}</button>
                        </div>
                    </header>
                    <p>${entry.content || ''}</p>
                    ${(entry.activities && entry.activities.length) ? `
                        <footer class="activities-list">
                            ${entry.activities.map(activity => `
                                <span class="activity-tag">${getActivityEmoji(activity)} ${activity}</span>
                            `).join('')}
                        </footer>
                    ` : ''}
                </article>
            `).join('');
        } catch (error) {
            console.error('Error loading entries:', error);
        }
    }

    // –î–µ–ª–µ–≥–æ–≤–∞–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
    document.getElementById('entriesList').addEventListener('click', async (e) => {
        const btn = e.target.closest('.delete-entry');
        if (!btn) return;
        const id = btn.dataset.id;
        if (!id) return;

    if (!confirm(t('confirm_delete_entry') || '–í–∏ —Å–ø—Ä–∞–≤–¥—ñ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å? –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.')) return;

        try {
            const resp = await fetch(`/api/journal/${id}`, { method: 'DELETE' });
            if (resp.ok) {
                // Optional: animate removal ‚Äî here we reload list for simplicity
                loadEntries();
            } else {
                const data = await resp.json().catch(() => ({}));
                alert(data.message || t('delete_failed') || '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å');
            }
        } catch (err) {
            console.error('Delete error:', err);
            alert(t('delete_failed') || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –∑–∞–ø–∏—Å—É');
        }
    });

    function getActivityEmoji(activity) {
        const emojis = {
            exercise: 'üèÉ‚Äç‚ôÇÔ∏è',
            meditation: 'üßò‚Äç‚ôÇÔ∏è',
            reading: 'üìö',
            social: 'üë•',
            nature: 'üå≥',
            work: 'üíº'
        };
        return emojis[activity] || 'üìù';
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ —Ç–∞ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    loadEntries();
    document.getElementById('monthFilter').addEventListener('change', loadEntries);
    document.getElementById('moodFilter').addEventListener('change', loadEntries);

    // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä —Ñ–æ—Ä–º–∞—Ç—ñ–≤ –¥–∞—Ç–∏/—Ç–µ–∫—Å—Ç—ñ–≤ –ø—Ä–∏ –∑–º—ñ–Ω—ñ –º–æ–≤–∏
    window.addEventListener('languageChanged', () => { try { loadEntries(); } catch(e){} });
</script>
{% endblock %}