{% extends "base.html" %}

{% block title %}–©–æ–¥–µ–Ω–Ω–∏–∫ - DailyMood{% endblock %}

{% block content %}

    <main class="journal-container">
        <h1>–ú—ñ–π —â–æ–¥–µ–Ω–Ω–∏–∫ –Ω–∞—Å—Ç—Ä–æ—é</h1>
        
    <section class="new-entry">
            <h2>–ù–æ–≤–∏–π –∑–∞–ø–∏—Å</h2>
            <form id="journalForm" class="journal-form">
                <div class="form-group">
                    <label for="mood">–ù–∞—Å—Ç—Ä—ñ–π:</label>
                    <select name="mood" id="mood" required>
                        <option value="happy">üòä –©–∞—Å–ª–∏–≤–∏–π</option>
                        <option value="neutral">üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–∏–π</option>
                        <option value="sad">üò¢ –°—É–º–Ω–∏–π</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="date">–î–∞—Ç–∞:</label>
                    <input type="date" id="date" name="date" required>
                </div>

                <div class="form-group">
                    <label for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
                    <input type="text" id="title" name="title" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –ø—Ä–æ –¥–µ–Ω—å" required>
                </div>

                <div class="form-group">
                    <label for="content">–û–ø–∏—Å –¥–Ω—è:</label>
                    <textarea id="content" name="content" rows="5" 
                              placeholder="–©–æ —Å—Ç–∞–ª–æ—Å—è —Å—å–æ–≥–æ–¥–Ω—ñ? –©–æ –≤–ø–ª–∏–Ω—É–ª–æ –Ω–∞ –≤–∞—à –Ω–∞—Å—Ç—Ä—ñ–π?"></textarea>
                </div>

                <div class="form-group">
                    <label for="activities">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ:</label>
                    <div class="activities-grid">
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="exercise">
                            üèÉ‚Äç‚ôÇÔ∏è –°–ø–æ—Ä—Ç
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="meditation">
                            üßò‚Äç‚ôÇÔ∏è –ú–µ–¥–∏—Ç–∞—Ü—ñ—è
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="reading">
                            üìö –ß–∏—Ç–∞–Ω–Ω—è
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="social">
                            üë• –°–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="nature">
                            üå≥ –ü—Ä–∏—Ä–æ–¥–∞
                        </label>
                        <label class="activity-item">
                            <input type="checkbox" name="activities" value="work">
                            üíº –†–æ–±–æ—Ç–∞
                        </label>
                    </div>
                </div>

                <button type="submit" class="btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–∞–ø–∏—Å</button>
            </form>
        </section>

    <section class="entries-list">
            <h2>–ú–æ—ó –∑–∞–ø–∏—Å–∏</h2>
            <div class="entries-filter">
                <input type="month" id="monthFilter">
                <select id="moodFilter">
                    <option value="">–í—Å—ñ –Ω–∞—Å—Ç—Ä–æ—ó</option>
                    <option value="happy">üòä –©–∞—Å–ª–∏–≤–∏–π</option>
                    <option value="neutral">üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–∏–π</option>
                    <option value="sad">üò¢ –°—É–º–Ω–∏–π</option>
                </select>
            </div>
            
            <div class="journal-entries" id="entriesList">
                <!-- –ó–∞–ø–∏—Å–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </section>
    </main>

{% endblock %}

{% block extra_scripts %}
<script>
    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—é –¥–∞—Ç—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
    document.getElementById('date').valueAsDate = new Date();

    // –û–±—Ä–æ–±–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º–∏
    document.getElementById('journalForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const activities = Array.from(formData.getAll('activities'));
        
        const entry = {
            mood: formData.get('mood'),
            date: formData.get('date'),
            title: formData.get('title'),
            content: formData.get('content'),
            activities: activities
        };

        try {
            const response = await fetch('/api/journal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(entry)
            });

            if (response.ok) {
                alert('–ó–∞–ø–∏—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
                loadEntries(); // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å—ñ–≤
                e.target.reset();
                document.getElementById('date').valueAsDate = new Date();
            } else {
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –∑–∞–ø–∏—Å—É');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –∑–∞–ø–∏—Å—É');
        }
    });

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–ø–∏—Å—ñ–≤
    async function loadEntries() {
        const monthFilter = document.getElementById('monthFilter').value;
        const moodFilter = document.getElementById('moodFilter').value;
        
        try {
            const response = await fetch(`/api/journal?month=${monthFilter}&mood=${moodFilter}`);
            if (!response.ok) {
                console.error('Failed to load entries', response.status);
                return;
            }
            const entries = await response.json();

            const entriesList = document.getElementById('entriesList');
            entriesList.innerHTML = entries.map(entry => `
                <article class="journal-entry mood-${entry.mood}" data-id="${entry.id}">
                    <header>
                        <div class="entry-header-left">
                            <h3>${entry.title}</h3>
                            <time datetime="${entry.date}">${new Date(entry.date).toLocaleDateString('uk-UA')}</time>
                        </div>
                        <div class="entry-header-right">
                            <button class="btn-link delete-entry" data-id="${entry.id}" title="–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                        </div>
                    </header>
                    <p>${entry.content || ''}</p>
                    ${(entry.activities && entry.activities.length) ? `
                        <footer class="activities-list">
                            ${entry.activities.map(activity => `
                                <span class="activity-tag">${getActivityEmoji(activity)} ${activity}</span>
                            `).join('')}
                        </footer>
                    ` : ''}
                </article>
            `).join('');
        } catch (error) {
            console.error('Error loading entries:', error);
        }
    }

    // –î–µ–ª–µ–≥–æ–≤–∞–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
    document.getElementById('entriesList').addEventListener('click', async (e) => {
        const btn = e.target.closest('.delete-entry');
        if (!btn) return;
        const id = btn.dataset.id;
        if (!id) return;

        if (!confirm('–í–∏ —Å–ø—Ä–∞–≤–¥—ñ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å? –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.')) return;

        try {
            const resp = await fetch(`/api/journal/${id}`, { method: 'DELETE' });
            if (resp.ok) {
                // Optional: animate removal ‚Äî here we reload list for simplicity
                loadEntries();
            } else {
                const data = await resp.json().catch(() => ({}));
                alert(data.message || '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å');
            }
        } catch (err) {
            console.error('Delete error:', err);
            alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –∑–∞–ø–∏—Å—É');
        }
    });

    function getActivityEmoji(activity) {
        const emojis = {
            exercise: 'üèÉ‚Äç‚ôÇÔ∏è',
            meditation: 'üßò‚Äç‚ôÇÔ∏è',
            reading: 'üìö',
            social: 'üë•',
            nature: 'üå≥',
            work: 'üíº'
        };
        return emojis[activity] || 'üìù';
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ —Ç–∞ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    loadEntries();
    document.getElementById('monthFilter').addEventListener('change', loadEntries);
    document.getElementById('moodFilter').addEventListener('change', loadEntries);
</script>
{% endblock %}