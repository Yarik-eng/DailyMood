{% extends "base.html" %}

{% block title %}Admin — Products{% endblock %}

{% block extra_head %}
<style>
  .admin-input, .admin-textarea, .admin-select {
    width: 100%;
    padding: 12px 14px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.05);
    font-size: 1rem;
    transition: all 0.18s ease;
    box-shadow: inset 0 2px 6px rgba(0,0,0,0.3);
  }
  
  .admin-input:focus, .admin-textarea:focus, .admin-select:focus {
    outline: none;
    border-color: rgba(99,102,241,0.6);
    box-shadow: 0 0 0 4px rgba(99,102,241,0.12), inset 0 2px 6px rgba(0,0,0,0.3);
    background: rgba(255,255,255,0.08);
  }
  
  .admin-input::placeholder, .admin-textarea::placeholder {
    color: rgba(255,255,255,0.4);
  }
  
  html.dark .admin-input, html.dark .admin-textarea, html.dark .admin-select {
    background: rgba(2,6,23,0.6);
    border-color: rgba(79,172,254,0.15);
    color: #e6eef8;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.6);
  }
  
  html:not(.dark) .admin-input, html:not(.dark) .admin-textarea, html:not(.dark) .admin-select {
    background: rgba(255,255,255,0.95);
    border-color: rgba(2,6,23,0.12);
    color: #0f172a;
    box-shadow: inset 0 1px 2px rgba(2,6,23,0.1);
  }
  
  html:not(.dark) .admin-input::placeholder, html:not(.dark) .admin-textarea::placeholder {
    color: rgba(15,23,42,0.4);
  }
  
  html:not(.dark) .admin-select option {
    background: #ffffff;
    color: #0f172a;
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-6 py-10">
  <section class="theme-panel card p-6" style="text-align:left;">
    <h1 class="text-2xl font-extrabold mb-4" data-i18n="admin_products_title">Управління продуктами</h1>
    <p class="muted" style="margin-bottom:12px;" data-i18n="admin_products_desc">Додайте, редагуйте або деактивуйте wellness-продукти для магазину.</p>

    <div class="panel-actions" style="justify-content:flex-start; gap:8px; margin-bottom:16px;">
      <button id="addProductBtn" class="btn" data-i18n="add_product">Додати продукт</button>
      <button id="refreshProductsBtn" class="btn secondary" data-i18n="refresh">Оновити</button>
    </div>

    <!-- Форма створення/редагування -->
    <div id="productFormWrap" class="add-form" style="display:none; margin-bottom:20px; padding:16px; background:rgba(255,255,255,0.02); border-radius:12px;">
      <h3 class="text-lg font-bold mb-3" id="formTitle" data-i18n="new_product">Новий продукт</h3>
      <form id="productForm" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <input type="hidden" id="editProductId">
        <input type="text" id="prodName" class="admin-input" placeholder="Назва" data-i18n="product_name" required>
        <input type="text" id="prodSlug" class="admin-input" placeholder="Slug (URL)" data-i18n="product_slug" required>
        <select id="prodType" class="admin-select" aria-label="Type" required>
          <option value="" data-i18n="product_type_select">Виберіть тип</option>
          <option value="quote_pack" data-i18n="type_quote_pack">Пакет цитат</option>
          <option value="theme" data-i18n="type_theme">Тема оформлення</option>
          <option value="journal_template" data-i18n="type_journal_template">Шаблон щоденника</option>
          <option value="habit_course" data-i18n="type_habit_course">Курс звичок</option>
        </select>
        <input type="number" id="prodPrice" class="admin-input" placeholder="Ціна" data-i18n="product_price" step="0.01" min="0" required>
        <textarea id="prodDesc" class="admin-textarea" rows="3" placeholder="Опис" data-i18n="product_description" style="grid-column:1/-1"></textarea>
        <label style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="prodActive" checked>
          <span data-i18n="product_active">Активний</span>
        </label>
        <div style="display:flex; gap:8px;">
          <button type="submit" class="btn" data-i18n="save">Зберегти</button>
          <button type="button" id="cancelFormBtn" class="btn secondary" data-i18n="cancel">Скасувати</button>
        </div>
      </form>
    </div>

    <!-- Таблиця продуктів -->
    <div class="entries-list" style="overflow:auto;">
      <table id="productsTable" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:8px; border-bottom:1px solid rgba(255,255,255,0.08);" data-i18n="id">ID</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid rgba(255,255,255,0.08);" data-i18n="name">Назва</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid rgba(255,255,255,0.08);" data-i18n="type">Тип</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid rgba(255,255,255,0.08);" data-i18n="price">Ціна</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid rgba(255,255,255,0.08);" data-i18n="status">Статус</th>
            <th style="text-align:right; padding:8px; border-bottom:1px solid rgba(255,255,255,0.08);" data-i18n="actions">Дії</th>
          </tr>
        </thead>
        <tbody id="productsBody"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
(function(){
  function t(key){ try { return (typeof currentLanguage!=='undefined' && currentLanguage==='uk') ? (translations_uk[key]||key) : (translations_en[key]||key); } catch(e){ return key; } }
  
  const bodyEl = document.getElementById('productsBody');
  const formWrap = document.getElementById('productFormWrap');
  const form = document.getElementById('productForm');
  const addBtn = document.getElementById('addProductBtn');
  const refreshBtn = document.getElementById('refreshProductsBtn');
  const cancelBtn = document.getElementById('cancelFormBtn');
  const formTitle = document.getElementById('formTitle');
  
  let editMode = false;

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

  async function loadProducts(){
    bodyEl.innerHTML = '<tr><td colspan="6" style="padding:10px; opacity:0.8;">'+t('loading')+'</td></tr>';
    try {
  const r = await fetch('/api/products', { credentials: 'include' });
      if(!r.ok) throw new Error('Bad response');
      const data = await r.json();
      if(!Array.isArray(data) || data.length===0){
        bodyEl.innerHTML = '<tr><td colspan="6" style="padding:10px; opacity:0.8;">'+t('no_products_yet')+'</td></tr>';
        return;
      }
      bodyEl.innerHTML = data.map(p => {
        const statusText = p.is_active ? t('active') : t('inactive');
        return `<tr data-id="${p.id}">
          <td style="padding:8px;">#${p.id}</td>
          <td style="padding:8px;">${escapeHtml(p.name)}</td>
          <td style="padding:8px;">${escapeHtml(p.type)}</td>
          <td style="padding:8px;">${p.price.toFixed(2)}</td>
          <td style="padding:8px;">${statusText}</td>
          <td style="padding:8px; text-align:right;">
            <button class="btn-link" data-action="edit" data-id="${p.id}">${t('edit')}</button>
            <button class="btn-link delete-entry" data-action="del" data-id="${p.id}">${t('delete')}</button>
          </td>
        </tr>`;
      }).join('');
    } catch(err){
      console.error('Load products failed', err);
      bodyEl.innerHTML = '<tr><td colspan="6" style="padding:10px; color:#ef4444;">'+t('load_failed')+'</td></tr>';
    }
  }

  function showForm(product = null){
    editMode = !!product;
    formTitle.textContent = product ? t('edit_product') : t('new_product');
    
    if(product){
      document.getElementById('editProductId').value = product.id;
      document.getElementById('prodName').value = product.name;
      document.getElementById('prodSlug').value = product.slug;
      document.getElementById('prodType').value = product.type;
      document.getElementById('prodPrice').value = product.price;
      document.getElementById('prodDesc').value = product.description || '';
      document.getElementById('prodActive').checked = product.is_active;
    } else {
      form.reset();
      document.getElementById('editProductId').value = '';
      document.getElementById('prodActive').checked = true;
    }
    
    formWrap.style.display = 'block';
  }

  function hideForm(){
    formWrap.style.display = 'none';
    form.reset();
    editMode = false;
  }

  async function saveProduct(e){
    e.preventDefault();
    const id = document.getElementById('editProductId').value;
    const payload = {
      name: document.getElementById('prodName').value.trim(),
      slug: document.getElementById('prodSlug').value.trim(),
      type: document.getElementById('prodType').value,
      description: document.getElementById('prodDesc').value.trim(),
      price: parseFloat(document.getElementById('prodPrice').value),
      is_active: document.getElementById('prodActive').checked
    };
    
    try {
      const url = editMode ? `/api/products/${id}` : '/api/products';
      const method = editMode ? 'PUT' : 'POST';
  const r = await fetch(url, { method, headers:{'Content-Type':'application/json'}, credentials: 'include', body: JSON.stringify(payload) });
      
      if(!r.ok){
        const err = await r.json().catch(()=>({}));
        alert(err.message || t('save_failed'));
        return;
      }
      
      hideForm();
      loadProducts();
    } catch(err){
      console.error('Save product failed', err);
      alert(t('save_failed'));
    }
  }

  async function deleteProduct(id){
    if(!confirm(t('confirm_delete_product'))) return;
    try {
  const r = await fetch(`/api/products/${id}`, { method: 'DELETE', credentials: 'include' });
      if(!r.ok) throw new Error('Bad response');
      loadProducts();
    } catch(err){
      console.error('Delete failed', err);
      alert(t('delete_failed'));
    }
  }

  async function editProduct(id){
    try {
  const r = await fetch('/api/products', { credentials: 'include' });
      if(!r.ok) throw new Error('Bad response');
      const data = await r.json();
      const product = data.find(p => p.id === parseInt(id));
      if(!product){
        alert(t('product_not_found'));
        return;
      }
      showForm(product);
    } catch(err){
      console.error('Edit load failed', err);
      alert(t('load_failed'));
    }
  }

  bodyEl.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-action]');
    if(!btn) return;
    const action = btn.getAttribute('data-action');
    const id = btn.getAttribute('data-id');
    if(action === 'del') deleteProduct(id);
    if(action === 'edit') editProduct(id);
  });

  addBtn.addEventListener('click', ()=> showForm());
  cancelBtn.addEventListener('click', hideForm);
  form.addEventListener('submit', saveProduct);
  refreshBtn.addEventListener('click', loadProducts);
  window.addEventListener('languageChanged', loadProducts);
  
  loadProducts();
})();
</script>
{% endblock %}
