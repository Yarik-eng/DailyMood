{% extends "base.html" %}

{% block title %}Profile ‚Äî DailyMood{% endblock %}

{% block extra_head %}
<style>
  .profile-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }
  
  .profile-header {
    background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(168,85,247,0.2));
    border-radius: 24px;
    padding: 2.5rem;
    margin-bottom: 2rem;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  .profile-header-content {
    display: flex;
    align-items: center;
    gap: 2rem;
    flex-wrap: wrap;
  }
  
  .profile-avatar {
    width: 96px;
    height: 96px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6366f1, #a855f7);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    font-weight: 700;
    color: white;
    text-transform: uppercase;
    box-shadow: 0 8px 24px rgba(99,102,241,0.4);
  }
  
  .profile-info {
    flex: 1;
    min-width: 250px;
  }
  
  .profile-email {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    word-break: break-all;
  }
  
  .profile-date {
    opacity: 0.7;
    font-size: 0.95rem;
  }
  
  .role-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 100px;
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .role-badge--admin {
    background: rgba(34,197,94,0.2);
    color: #86efac;
    border: 1px solid rgba(34,197,94,0.3);
  }
  
  .role-badge--user {
    background: rgba(59,130,246,0.2);
    color: #93c5fd;
    border: 1px solid rgba(59,130,246,0.3);
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .stat-card {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px;
    padding: 1.75rem;
    transition: all 0.3s ease;
  }
  
  .stat-card:hover {
    background: rgba(255,255,255,0.08);
    transform: translateY(-2px);
    box-shadow: 0 12px 28px rgba(0,0,0,0.3);
  }
  
  .stat-label {
    font-size: 0.875rem;
    opacity: 0.7;
    margin-bottom: 0.75rem;
    display: block;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .stat-value {
    font-size: 2.5rem;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 0.25rem;
  }
  
  .stat-hint {
    font-size: 0.875rem;
    opacity: 0.6;
  }
  
  .orders-section {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 24px;
    padding: 2rem;
  }
  
  .orders-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .orders-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
  }
  
  .order-card {
    background: rgba(15,23,42,0.4);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
  }
  
  .order-card:hover {
    background: rgba(15,23,42,0.6);
    border-color: rgba(99,102,241,0.4);
    transform: translateX(4px);
  }
  
  .order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }
  
  .order-id {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: rgba(99,102,241,0.2);
    font-weight: 700;
    font-size: 1.1rem;
  }
  
  .order-info {
    flex: 1;
    min-width: 150px;
  }
  
  .order-date {
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  
  .order-amount {
    font-size: 0.9rem;
    opacity: 0.7;
  }
  
  .status-badge {
    padding: 0.5rem 1rem;
    border-radius: 100px;
    font-size: 0.875rem;
    font-weight: 600;
    white-space: nowrap;
  }
  
  .status-badge--new {
    background: rgba(59,130,246,0.2);
    color: #93c5fd;
  }
  
  .status-badge--processing {
    background: rgba(234,179,8,0.2);
    color: #fde047;
  }
  
  .status-badge--completed {
    background: rgba(34,197,94,0.2);
    color: #86efac;
  }
  
  .status-badge--canceled {
    background: rgba(239,68,68,0.2);
    color: #fca5a5;
  }
  
  .order-items {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  
  .order-item-tag {
    padding: 0.375rem 0.875rem;
    border-radius: 100px;
    background: rgba(255,255,255,0.08);
    font-size: 0.875rem;
  }
  
  .empty-state {
    text-align: center;
    padding: 3rem 1.5rem;
    border: 2px dashed rgba(255,255,255,0.15);
    border-radius: 16px;
  }
  
  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }
  
  .empty-state-text {
    opacity: 0.7;
    margin-bottom: 1.5rem;
  }
  
  html:not(.dark) .profile-header {
    background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(168,85,247,0.08));
  }
  
  html:not(.dark) .stat-card {
    background: rgba(0,0,0,0.02);
    border-color: rgba(0,0,0,0.08);
  }
  
  html:not(.dark) .order-card {
    background: rgba(0,0,0,0.02);
    border-color: rgba(0,0,0,0.08);
  }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–æ—Ñ—ñ–ª—é -->
  <div class="profile-header">
    <div class="profile-header-content">
      <div id="profileAvatar" class="profile-avatar">A</div>
      <div class="profile-info">
        <h1 id="profileEmail" class="profile-email">‚Äî</h1>
        <div class="profile-date">
          <span data-i18n="profile_registered_at">–ó–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ</span>: 
          <span id="profileCreated">‚Äî</span>
        </div>
      </div>
      <div style="display: flex; flex-direction: column; gap: 1rem; align-items: center;">
        <span id="profileRoleBadge" class="role-badge">‚Äî</span>
        <a id="profileAdminShortcut" href="{{ url_for('admin_dashboard') }}" class="btn" style="display:none;" data-i18n="profile_open_admin">–í—ñ–¥–∫—Ä–∏—Ç–∏ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</a>
      </div>
    </div>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="stats-grid">
    <div class="stat-card">
      <span class="stat-label" data-i18n="profile_total_orders">–£—Å—å–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω—å</span>
      <div class="stat-value" id="profileTotalOrders">0</div>
      <div class="stat-hint" data-i18n="profile_orders_recent">–∑–∞ –≤–µ—Å—å —á–∞—Å</div>
    </div>
    
    <div class="stat-card">
      <span class="stat-label" data-i18n="profile_completed_orders">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
      <div class="stat-value" id="profileCompletedOrders">0</div>
      <div class="stat-hint" data-i18n="profile_completed_hint">—É—Å–ø—ñ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</div>
    </div>
    
    <div class="stat-card">
      <span class="stat-label" data-i18n="profile_total_spent">–°—É–º–∞ –ø–æ–∫—É–ø–æ–∫</span>
      <div style="display: flex; align-items: baseline; gap: 0.5rem;">
        <div class="stat-value" id="profileTotalSpent">0.00</div>
        <div class="stat-hint" data-i18n="profile_total_spent_hint">–≥—Ä–Ω</div>
      </div>
    </div>
  </div>

  <!-- –°–µ–∫—Ü—ñ—è –∑–∞–º–æ–≤–ª–µ–Ω—å -->
  <div class="orders-section">
    <div class="orders-header">
      <div>
        <h2 class="orders-title" data-i18n="profile_orders_section">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>
        <p class="muted" style="margin: 0.5rem 0 0;" data-i18n="profile_orders_caption">–û—Å—Ç–∞–Ω–Ω—ñ –ø–æ–∫—É–ø–∫–∏ —Ç–∞ —ó—Ö–Ω—ñ–π —Å—Ç–∞—Ç—É—Å</p>
      </div>
      <a href="{{ url_for('store') }}" class="btn secondary" data-i18n="profile_go_to_store">–î–æ –º–∞–≥–∞–∑–∏–Ω—É</a>
    </div>
    <div id="ordersContainer"></div>
  </div>
</div>

<script>
(function(){
  function t(key){ 
    try { 
      return (typeof currentLanguage!=='undefined' && currentLanguage==='uk') 
        ? (translations_uk[key]||key) 
        : (translations_en[key]||key); 
    } catch(e){ 
      return key; 
    } 
  }
  
  const emailEl = document.getElementById('profileEmail');
  const roleBadge = document.getElementById('profileRoleBadge');
  const createdEl = document.getElementById('profileCreated');
  const adminBtn = document.getElementById('profileAdminShortcut');
  const ordersContainer = document.getElementById('ordersContainer');
  const avatarEl = document.getElementById('profileAvatar');
  const totalOrdersEl = document.getElementById('profileTotalOrders');
  const completedOrdersEl = document.getElementById('profileCompletedOrders');
  const totalSpentEl = document.getElementById('profileTotalSpent');

  function formatDate(iso){ 
    try { 
      return new Date(iso).toLocaleString('uk-UA', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch(e){ 
      return iso || '‚Äî'; 
    } 
  }

  async function loadProfile(){
    try {
      const r = await fetch('/api/me', { credentials: 'include' });
      if(!r.ok) throw new Error('auth');
      const payload = await r.json();
      const user = payload.user || {};
      
      emailEl.textContent = user.email || '‚Äî';
      roleBadge.textContent = user.is_admin ? t('profile_role_admin') : t('profile_role_user');
      roleBadge.className = user.is_admin ? 'role-badge role-badge--admin' : 'role-badge role-badge--user';
      createdEl.textContent = formatDate(user.created_at);
      adminBtn.style.display = user.is_admin ? 'inline-flex' : 'none';
      
      if(user.email){
        avatarEl.textContent = user.email.charAt(0).toUpperCase();
      }
    } catch(err){
      console.error('Profile load failed', err);
      emailEl.textContent = '‚Äî';
      roleBadge.textContent = '‚Äî';
      createdEl.textContent = '‚Äî';
      adminBtn.style.display = 'none';
    }
  }

  function renderOrders(list){
    if(!Array.isArray(list) || list.length === 0){
      ordersContainer.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üì¶</div>
          <p class="empty-state-text">${t('profile_no_orders')}</p>
          <a href="{{ url_for('store') }}" class="btn secondary">${t('profile_go_to_store')}</a>
        </div>`;
      return;
    }
    
    const markup = list.map(o => {
      const statusLabel = t('order_status_' + o.status) || o.status;
      const amount = Number(o.total_amount || 0);
      const itemsHtml = (o.items && o.items.length)
        ? `<div class="order-items">${o.items.map(item => 
            `<span class="order-item-tag">${item.product_name} √ó ${item.quantity}</span>`
          ).join('')}</div>`
        : '';
        
      return `
        <div class="order-card">
          <div class="order-header">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div class="order-id">#${o.id}</div>
              <div class="order-info">
                <div class="order-date">${formatDate(o.created_at)}</div>
                <div class="order-amount">${t('total')}: ${amount.toFixed(2)} –≥—Ä–Ω</div>
              </div>
            </div>
            <span class="status-badge status-badge--${o.status}">${statusLabel}</span>
          </div>
          ${itemsHtml}
        </div>`;
    }).join('');
    
    ordersContainer.innerHTML = markup;
  }

  async function loadOrders(){
    ordersContainer.innerHTML = '<p class="muted" style="text-align:center; padding:2rem;">'+t('loading')+'...</p>';
    try {
      const r = await fetch('/api/orders', { credentials: 'include' });
      if(!r.ok) throw new Error('orders');
      const list = await r.json();
      
      const completed = list.filter(o => o.status === 'completed').length;
      const total = list.length;
      const spent = list.filter(o => o.status === 'completed').reduce((acc, o) => acc + Number(o.total_amount || 0), 0);
      
      totalOrdersEl.textContent = total;
      completedOrdersEl.textContent = completed;
      totalSpentEl.textContent = spent.toFixed(2);
      
      renderOrders(list.slice(0, 10));
    } catch(err){
      console.error('Orders load failed', err);
      ordersContainer.innerHTML = '<p style="color:#ef4444; text-align:center; padding:2rem;">'+t('load_failed')+'</p>';
    }
  }

  window.addEventListener('languageChanged', ()=>{
    loadProfile();
    loadOrders();
  });

  loadProfile();
  loadOrders();
})();
</script>
{% endblock %}
