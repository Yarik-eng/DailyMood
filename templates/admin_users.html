{% extends "base.html" %}

{% block title %}Admin — Users{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-6 py-10">
  <section class="theme-panel card p-6" style="text-align:left;">
    <div style="display:flex; flex-direction:column; gap:12px; margin-bottom:18px;">
      <div>
        <h1 class="text-2xl font-extrabold" data-i18n="admin_users_title">Керування користувачами</h1>
        <p class="muted" data-i18n="admin_users_desc">Призначайте або забирайте адмін-права та очищуйте список користувачів.</p>
      </div>
      <div class="panel-actions" style="display:flex; gap:10px;">
        <button id="refreshUsersBtn" class="btn secondary" data-i18n="refresh">Оновити</button>
      </div>
    </div>

    <div class="entries-list" style="overflow:auto;">
      <table id="usersTable" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:8px; border-bottom:1px solid rgba(255,255,255,0.08);" data-i18n="id">ID</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid rgba(255,255,255,0.08);" data-i18n="email">Email</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid rgba(255,255,255,0.08);" data-i18n="role">Роль</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid rgba(255,255,255,0.08);" data-i18n="premium_status">Преміум</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid rgba(255,255,255,0.08);" data-i18n="profile_registered_at">Зареєстровано</th>
            <th style="text-align:right; padding:8px; border-bottom:1px solid rgba(255,255,255,0.08);" data-i18n="actions">Дії</th>
          </tr>
        </thead>
        <tbody id="usersBody"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
(function(){
  const PRIMARY_EMAIL = 'admin_1@gmail.com';
  const usersBody = document.getElementById('usersBody');
  const refreshBtn = document.getElementById('refreshUsersBtn');
  let currentUserId = null;

  function t(key){
    try {
      return (typeof currentLanguage !== 'undefined' && currentLanguage === 'uk') ? (translations_uk[key] || key) : (translations_en[key] || key);
    } catch(err){
      return key;
    }
  }

  function escapeHtml(value){
    return (value || '').replace(/[&<>"']/g, function(ch){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]);
    });
  }

  function formatDate(iso){
    try {
      return new Date(iso).toLocaleString();
    } catch(err){
      return iso || '—';
    }
  }

  async function loadCurrentUser(){
    try {
      const response = await fetch('/api/me', { credentials: 'include' });
      if(!response.ok) return;
      const payload = await response.json();
      if(payload && payload.user){
  currentUserId = payload.user.id;
      }
    } catch(err){
      console.error('Failed to load current user', err);
    }
  }

  function renderUsers(users){
    if(!Array.isArray(users) || users.length === 0){
      usersBody.innerHTML = `<tr><td colspan="6" style="padding:10px; opacity:0.8;">${t('admin_users_empty')}</td></tr>`;
      return;
    }

    usersBody.innerHTML = users.map(user => {
      const isAdmin = !!user.is_admin;
      const isPrimary = user.email === PRIMARY_EMAIL;
      const isCurrent = currentUserId === user.id;
      const roleLabel = isAdmin ? t('admin_role_admin') : t('admin_role_user');
      const roleChip = `<span style="display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:0.85rem; background:${isAdmin ? 'rgba(34,197,94,0.18)' : 'rgba(148,163,184,0.18)'}; color:${isAdmin ? '#bbf7d0' : '#e2e8f0'};">${escapeHtml(roleLabel)}</span>`;
      const premiumActive = !!user.is_premium;
      const premiumLabel = premiumActive ? t('premium_status_active') : t('premium_status_free');
      const premiumChip = `<span style="display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:0.85rem; background:${premiumActive ? 'rgba(248,250,133,0.25)' : 'rgba(148,163,184,0.15)'}; color:${premiumActive ? '#facc15' : '#e2e8f0'};">${escapeHtml(premiumLabel)}</span>`;
      const created = formatDate(user.created_at);

      const disableToggle = isPrimary;
      const disableDelete = isPrimary || isCurrent;
      const toggleLabel = isAdmin ? t('admin_remove_admin') : t('admin_make_admin');
      const premiumToggleLabel = premiumActive ? t('admin_remove_premium') : t('admin_make_premium');
      const deleteLabel = t('admin_delete_user');
      const legend = isPrimary ? `<div style="font-size:0.8rem; opacity:0.7; margin-top:4px;">${t('admin_primary_label')}</div>` : '';

      const toggleBtn = `<button class="btn-link" data-action="toggle" data-id="${user.id}" data-admin="${isAdmin ? '1' : '0'}" ${disableToggle ? 'disabled' : ''}>${escapeHtml(toggleLabel)}</button>`;
      const premiumBtn = `<button class="btn-link" data-action="premium" data-id="${user.id}" data-premium="${premiumActive ? '1' : '0'}">${escapeHtml(premiumToggleLabel)}</button>`;
      const deleteBtn = `<button class="btn-link delete-entry" data-action="delete" data-id="${user.id}" ${disableDelete ? 'disabled' : ''}>${escapeHtml(deleteLabel)}</button>`;

      return `<tr>
        <td style="padding:8px;">#${user.id}</td>
        <td style="padding:8px;">
          <div>${escapeHtml(user.email)}</div>
          ${legend}
        </td>
        <td style="padding:8px;">${roleChip}</td>
  <td style="padding:8px;">${premiumChip}</td>
        <td style="padding:8px;">${escapeHtml(created)}</td>
        <td style="padding:8px; text-align:right; display:flex; justify-content:flex-end; gap:12px;">
          ${toggleBtn}
          ${premiumBtn}
          ${deleteBtn}
        </td>
      </tr>`;
    }).join('');
  }

  async function loadUsers(){
  usersBody.innerHTML = `<tr><td colspan="6" style="padding:10px; opacity:0.8;">${t('loading')}</td></tr>`;
    try {
      const response = await fetch('/api/admin/users', { credentials: 'include' });
      if(!response.ok) throw new Error('Bad response');
      const payload = await response.json();
      renderUsers(payload.users || []);
    } catch(err){
      console.error('Failed to load users', err);
      usersBody.innerHTML = `<tr><td colspan="6" style="padding:10px; color:#ef4444;">${t('load_failed')}</td></tr>`;
    }
  }

  async function toggleAdmin(userId, makeAdmin){
    try {
      const response = await fetch(`/api/admin/users/${userId}/admin`, {
        method: 'PUT',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_admin: makeAdmin })
      });
      if(!response.ok){
        const err = await response.json().catch(() => ({}));
        alert(err.message || t('save_failed'));
        return;
      }
      await loadUsers();
    } catch(err){
      console.error('Failed to toggle admin role', err);
      alert(t('save_failed'));
    }
  }

  async function togglePremium(userId, makePremium){
    try {
      const response = await fetch(`/api/admin/users/${userId}/premium`, {
        method: 'PUT',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_premium: makePremium })
      });
      if(!response.ok){
        const err = await response.json().catch(() => ({}));
        alert(err.message || t('save_failed'));
        return;
      }
      await loadUsers();
    } catch(err){
      console.error('Failed to toggle premium status', err);
      alert(t('save_failed'));
    }
  }

  async function deleteUser(userId){
    if(!confirm(t('admin_confirm_delete_user'))){
      return;
    }
    try {
      const response = await fetch(`/api/admin/users/${userId}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      if(!response.ok){
        const err = await response.json().catch(() => ({}));
        alert(err.message || t('delete_failed'));
        return;
      }
      await loadUsers();
    } catch(err){
      console.error('Failed to delete user', err);
      alert(t('delete_failed'));
    }
  }

  usersBody.addEventListener('click', (event) => {
    const btn = event.target.closest('[data-action]');
    if(!btn || btn.disabled) return;
    const action = btn.getAttribute('data-action');
    const userId = parseInt(btn.getAttribute('data-id'), 10);
    if(Number.isNaN(userId)) return;

    if(action === 'toggle'){
      const isAdmin = btn.getAttribute('data-admin') === '1';
      toggleAdmin(userId, !isAdmin);
    }
    if(action === 'premium'){
      const hasPremium = btn.getAttribute('data-premium') === '1';
      togglePremium(userId, !hasPremium);
    }
    if(action === 'delete'){
      deleteUser(userId);
    }
  });

  refreshBtn.addEventListener('click', loadUsers);
  window.addEventListener('languageChanged', loadUsers);

  (async function init(){
    await loadCurrentUser();
    await loadUsers();
  })();
})();
</script>
{% endblock %}
