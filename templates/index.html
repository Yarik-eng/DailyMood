{% extends "base.html" %}

{% block title %}DailyMood ‚Äî Home{% endblock %}

{% block content %}
<div class="quote-wrap">
  <div class="card">
    <div class="quote-inner">
        <p id="quoteText">&nbsp;</p>
      </div>
  </div>
  <div class="controls">
    <button id="newQuote" class="btn secondary" data-i18n="new_quote">–ù–æ–≤–∞ —Ü–∏—Ç–∞—Ç–∞</button>
    <button id="copyQuote" class="btn secondary" data-i18n="copy_quote">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
    <button id="saveQuote" class="btn secondary" data-i18n="save_quote">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
  </div>
  <p class="muted"><small data-i18n="tip_new_quote">–ü—ñ–¥–∫–∞–∑–∫–∞: –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å N –¥–ª—è –Ω–æ–≤–æ—ó —Ü–∏—Ç–∞—Ç–∏</small></p>
</div>

<section class="card theme-panel" id="activityRecsSection" style="display:none; margin-top:20px;">
  <h2 data-i18n="activity_recs_title">üéØ Activity Recommendations <span style="font-size:0.7em; color:#60a5fa; font-weight:600;" data-i18n="premium_badge">PREMIUM</span></h2>
  <p class="muted" style="margin-bottom:12px;" data-i18n="activity_recs_desc">–ü–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –ø–æ—Ä–∞–¥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç–≤–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ—é</p>
  
  <div id="recsContent" style="display:none;">
    <div style="background:rgba(96,165,250,0.1); border-left:3px solid #60a5fa; padding:12px; border-radius:8px; margin-bottom:14px;">
      <p id="recsMoodTitle" style="font-size:1.1em; font-weight:700; margin:0;"></p>
    </div>
    
    <div id="recsActivities" style="display:grid; gap:10px; margin-bottom:12px;"></div>
    
    <div id="recsTip" style="background:rgba(251,191,36,0.1); border-left:3px solid #fbbf24; padding:10px; border-radius:8px; font-size:0.95em;"></div>
  </div>
  
  <div id="recsLocked" style="text-align:center; padding:20px;">
    <p style="font-size:1.1em; margin-bottom:12px;" data-i18n="premium_required">üîí –¶—è —Ñ—É–Ω–∫—Ü—ñ—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ –¥–ª—è Premium –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</p>
    <a href="/store" class="btn" data-i18n="get_premium">–û—Ç—Ä–∏–º–∞—Ç–∏ Premium</a>
  </div>
  
  <div id="recsError" style="display:none; color:#ef4444; text-align:center; padding:12px;"></div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
  (function () {
    // Get quotes based on current language
    const QUOTES = currentLanguage === 'uk' ? translations_quotes_uk : translations_quotes_en;

    const quoteText = document.getElementById('quoteText');
    const newBtn = document.getElementById('newQuote');
    const copyBtn = document.getElementById('copyQuote');
    const saveBtn = document.getElementById('saveQuote');

    let currentIndex = -1;
    let animating = false;
    let firstRender = true;

    // Favorites (localStorage)
    const FAVORITES_KEY = 'dailyMoodFavorites';
    function loadFavorites() { 
      try {
        const raw = JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
        if (!Array.isArray(raw)) return [];
        return raw.map(item => {
          if (typeof item === 'string') return { text: item, favorite: false };
          if (item && typeof item === 'object' && 'text' in item) return { text: String(item.text), favorite: !!item.favorite };
          return null;
        }).filter(Boolean);
      } catch(e) { return []; }
    }
    function saveFavorites(arr) { try { localStorage.setItem(FAVORITES_KEY, JSON.stringify(arr)); } catch(e) {} }
    function isCurrentSaved() { const items = loadFavorites(); return items.some(it => it.text === quoteText.textContent); }
  function updateSaveButton() { if (!saveBtn) return; const texts = currentLanguage === 'uk' ? translations_uk : translations_en; saveBtn.textContent = isCurrentSaved() ? (texts.saved_quote || 'Saved') : (texts.save_quote || 'Save'); }

    function randomIndexExcluding(max, exclude) {
      if (max <= 1) return 0;
      let idx = Math.floor(Math.random() * max);
      if (idx === exclude) idx = (idx + 1) % max;
      return idx;
    }

    // Set quote with optional animation
    function setQuoteAnimated(text) {
      if (animating) return;
      animating = true;
      
      if (firstRender) {
        quoteText.textContent = text;
        animating = false;
        firstRender = false;
        return;
      }

      quoteText.classList.add('fade-exit');
      quoteText.offsetHeight;
      quoteText.classList.add('fade-exit-active');
      
      setTimeout(() => {
        quoteText.classList.remove('fade-exit', 'fade-exit-active');
        quoteText.textContent = text;
        quoteText.classList.add('fade-enter');
        quoteText.offsetHeight;
        quoteText.classList.add('fade-enter-active');
        
        setTimeout(() => {
          quoteText.classList.remove('fade-enter', 'fade-enter-active');
          animating = false;
        }, 380);
      }, 180);
    }

    function showRandomQuote() {
      const quotes = currentLanguage === 'uk' ? translations_quotes_uk : translations_quotes_en;
      const idx = randomIndexExcluding(quotes.length, currentIndex);
      currentIndex = idx;
      setQuoteAnimated(quotes[idx]);
    }

    async function copyQuote() {
      const text = quoteText.textContent;
      if (!text) return;
      
      try {
        await navigator.clipboard.writeText(text);
        const original = copyBtn.textContent;
        const texts = currentLanguage === 'uk' ? translations_uk : translations_en;
        copyBtn.textContent = texts.copied || 'Copied!';
        setTimeout(() => { 
          copyBtn.textContent = original; 
        }, 1200);
      } catch (e) {
        const texts = currentLanguage === 'uk' ? translations_uk : translations_en;
        prompt(texts.copy || 'Copy', text);
      }
    }

    function onKey(e) {
      if (e.key === 'n' || e.key === 'N') showRandomQuote();
    }

    // Event listeners
    newBtn.addEventListener('click', () => {
      showRandomQuote();
      setTimeout(updateSaveButton, 350);
    });

    copyBtn.addEventListener('click', copyQuote);

    if (saveBtn) {
      saveBtn.addEventListener('click', () => {
        const text = quoteText.textContent;
        if (!text) return;
  const items = loadFavorites();
  const idx = items.findIndex(it => it && it.text === text);
        const wasEmpty = items.length === 0;

        if (idx === -1) {
          // ensure we store objects with a favorite flag
          items.unshift({ text, favorite: true });
          saveFavorites(items);
          updateSaveButton();

          // If this is the first saved quote, set it as the daily quote (persist locally)
          if (wasEmpty) {
            try {
              const today = new Date().toISOString().slice(0,10);
              localStorage.setItem('dailyMoodDailyQuote', text);
              localStorage.setItem('dailyMoodDailyQuoteDate', today);
              const dq = document.getElementById('dailyQuoteText');
              const da = document.getElementById('dailyQuoteAuthor');
              if (dq) dq.textContent = text;
              if (da) da.textContent = '';
            } catch (e) {
              console.warn('Could not persist daily quote', e);
            }
          }
          // Notify other pages that favorites changed
          try { window.dispatchEvent(new Event('favoritesUpdated')); } catch(e){}
        } else {
          // if already saved, remove it entirely
          items.splice(idx, 1);
          saveFavorites(items);
          updateSaveButton();
          try { window.dispatchEvent(new Event('favoritesUpdated')); } catch(e){}
        }
      });
    }

    window.addEventListener('keydown', onKey);

    // Language change handler
    window.addEventListener('languageChanged', () => {
      // Update button texts
      const texts = currentLanguage === 'uk' ? translations_uk : translations_en;
      if (newBtn) newBtn.textContent = texts.new_quote || 'New Quote';
      if (copyBtn) copyBtn.textContent = texts.copy_quote || 'Copy';
      if (saveBtn) updateSaveButton();

      // Show new quote without animation
      firstRender = true;
      showRandomQuote();
      setTimeout(updateSaveButton, 60);
    });

    // Initialize
    showRandomQuote();
    setTimeout(updateSaveButton, 300);

    // -------------------- Activity Recommendations (Premium) --------------------
    (async function initActivityRecs() {
      const section = document.getElementById('activityRecsSection');
      const content = document.getElementById('recsContent');
      const locked = document.getElementById('recsLocked');
      const errorEl = document.getElementById('recsError');
      
      if (!section) return;
      
      try {
        // Check if user is logged in and premium
        const userRes = await fetch('/api/me', { credentials: 'include' });
        if (!userRes.ok) {
          // Not logged in - hide section
          return;
        }
        
        const userData = await userRes.json();
        const user = userData.user || {};
        
        section.style.display = '';
        
        if (!user.is_premium) {
          // Show locked state
          locked.style.display = '';
          content.style.display = 'none';
          return;
        }
        
        // Premium user - fetch recommendations
        const recsRes = await fetch('/api/premium/activity-recommendations', { credentials: 'include' });
        
        if (!recsRes.ok) {
          throw new Error('Failed to load recommendations');
        }
        
        const data = await recsRes.json();
        
        if (data.status === 'success') {
          locked.style.display = 'none';
          content.style.display = '';
          
          // Set title
          document.getElementById('recsMoodTitle').textContent = (data.mood_emoji || '') + ' ' + (data.title || '');
          
          // Render activities
          const activitiesEl = document.getElementById('recsActivities');
          activitiesEl.innerHTML = '';
          
          if (data.activities && data.activities.length) {
            data.activities.forEach(activity => {
              const card = document.createElement('div');
              card.style.cssText = 'background:rgba(255,255,255,0.03); padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.1);';
              card.innerHTML = `
                <div style="display:flex; gap:10px; align-items:start;">
                  <div style="font-size:1.8em; line-height:1;">${activity.icon || '‚Ä¢'}</div>
                  <div style="flex:1;">
                    <div style="font-weight:700; margin-bottom:4px;">${activity.name || ''}</div>
                    <div style="opacity:0.8; font-size:0.9em; margin-bottom:4px;">${activity.description || ''}</div>
                    <div class="muted" style="font-size:0.85em;">${activity.duration || ''}</div>
                  </div>
                </div>
              `;
              activitiesEl.appendChild(card);
            });
          }
          
          // Set tip
          if (data.tip) {
            document.getElementById('recsTip').innerHTML = `<strong>üí° –ü–æ—Ä–∞–¥–∞:</strong> ${data.tip}`;
          }
        } else {
          throw new Error(data.message || 'Unknown error');
        }
        
      } catch (err) {
        console.error('Activity Recommendations error:', err);
        if (errorEl) {
          errorEl.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.';
          errorEl.style.display = 'block';
        }
      }
    })();
  })();
</script>
{% endblock %}