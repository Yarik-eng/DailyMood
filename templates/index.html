{% extends "base.html" %}

{% block title %}DailyMood ‚Äî Home{% endblock %}

{% block content %}
<style>
.sparkle-particle {
  position: fixed;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: radial-gradient(circle, var(--particle-color-1) 0%, var(--particle-color-2) 30%, var(--particle-color-3) 60%, transparent 100%);
  pointer-events: none;
  z-index: 1;
  animation: sparkle-burst 3s ease-out forwards;
  filter: blur(20px);
  opacity: 1;
}

@keyframes sparkle-burst {
  0% {
    transform: translate(0, 0) scale(0.2);
    opacity: 1;
  }
  30% {
    opacity: 0.9;
  }
  70% {
    opacity: 0.5;
  }
  100% {
    transform: translate(var(--tx), var(--ty)) scale(2);
    opacity: 0;
  }
}
</style>
<div class="quote-wrap" data-advice-unlock-once="{% if advice_unlock_once %}true{% else %}false{% endif %}">
  <div class="card" id="adviceCard">
    <div class="quote-inner">
        <p id="quoteText">&nbsp;</p>
      </div>
  </div>
  <div class="controls">
    <button id="newQuote" class="btn secondary" data-i18n="new_advice">–ù–æ–≤–∞ –ø–æ—Ä–∞–¥–∞</button>
    <button id="copyQuote" class="btn secondary" data-i18n="copy_quote">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
    <button id="saveQuote" class="btn secondary" data-i18n="save_quote">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
  </div>
  <p class="muted"><small data-i18n="tip_new_advice">–ü—ñ–¥–∫–∞–∑–∫–∞: –Ω–∞—Ç–∏—Å–Ω–∏ N, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ä–∞–¥—É</small></p>
</div>

<section class="card theme-panel" id="activityRecsSection" style="display:none; margin-top:20px;">
  <h2 data-i18n="activity_recs_title">üéØ Activity Recommendations <span style="font-size:0.7em; color:#60a5fa; font-weight:600;" data-i18n="premium_badge">PREMIUM</span></h2>
  <p class="muted" style="margin-bottom:12px;" data-i18n="activity_recs_desc">–ü–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –ø–æ—Ä–∞–¥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç–≤–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ—é</p>
  
  <div id="recsContent" style="display:none;">
    <div style="background:rgba(96,165,250,0.1); border-left:3px solid #60a5fa; padding:12px; border-radius:8px; margin-bottom:14px;">
      <p id="recsMoodTitle" style="font-size:1.1em; font-weight:700; margin:0;"></p>
    </div>
    
    <div id="recsActivities" style="display:grid; gap:10px; margin-bottom:12px;"></div>
    
    <div id="recsTip" style="background:rgba(251,191,36,0.1); border-left:3px solid #fbbf24; padding:10px; border-radius:8px; font-size:0.95em;"></div>
  </div>
  
  <div id="recsLocked" style="text-align:center; padding:20px;">
    <p style="font-size:1.1em; margin-bottom:12px;" data-i18n="premium_required">üîí –¶—è —Ñ—É–Ω–∫—Ü—ñ—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ –¥–ª—è Premium –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</p>
    <a href="/store" class="btn" data-i18n="get_premium">–û—Ç—Ä–∏–º–∞—Ç–∏ Premium</a>
  </div>
  
  <div id="recsError" style="display:none; color:#ef4444; text-align:center; padding:12px;"></div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
  (function () {
    // Get quotes based on current language
    const QUOTES = currentLanguage === 'uk' ? translations_quotes_uk : translations_quotes_en;
    let ADVICE_UNLOCK_ONCE = document.querySelector('.quote-wrap').getAttribute('data-advice-unlock-once') === 'true';

    const quoteText = document.getElementById('quoteText');
    const newBtn = document.getElementById('newQuote');
    const copyBtn = document.getElementById('copyQuote');
    const saveBtn = document.getElementById('saveQuote');
    const ROLL_KEY = 'dailyMoodQuoteRollDate';
    const QUOTE_OF_DAY_KEY = 'dailyMoodQuoteOfDay';

    function todayStr(){ return new Date().toISOString().slice(0,10); }
    function setRollDisabled(disabled){
      if (!newBtn) return;
      newBtn.disabled = disabled;
      newBtn.classList.toggle('disabled', disabled);
      const texts = currentLanguage === 'uk' ? translations_uk : translations_en;
      if (disabled) {
        newBtn.textContent = (texts.daily_advice_locked || '–ü–æ—Ä–∞–¥–∞ –¥–Ω—è –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∞');
        newBtn.setAttribute('data-i18n', 'daily_advice_locked');
      } else {
        newBtn.textContent = (texts.new_advice || '–ù–æ–≤–∞ –ø–æ—Ä–∞–¥–∞');
        newBtn.setAttribute('data-i18n', 'new_advice');
      }
    }

    let currentIndex = -1;
    let animating = false;
    let firstRender = true;

    // Favorites (localStorage)
    const FAVORITES_KEY = 'dailyMoodFavorites';
    function loadFavorites() { 
      try {
        const raw = JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
        if (!Array.isArray(raw)) return [];
        return raw.map(item => {
          if (typeof item === 'string') return { text: item, favorite: false };
          if (item && typeof item === 'object' && 'text' in item) return { text: String(item.text), favorite: !!item.favorite };
          return null;
        }).filter(Boolean);
      } catch(e) { return []; }
    }
    function saveFavorites(arr) { try { localStorage.setItem(FAVORITES_KEY, JSON.stringify(arr)); } catch(e) {} }
    function isCurrentSaved() { const items = loadFavorites(); return items.some(it => it.text === quoteText.textContent); }
  function updateSaveButton() { if (!saveBtn) return; const texts = currentLanguage === 'uk' ? translations_uk : translations_en; saveBtn.textContent = isCurrentSaved() ? (texts.saved_quote || 'Saved') : (texts.save_quote || 'Save'); }

    function randomIndexExcluding(max, exclude) {
      if (max <= 1) return 0;
      let idx = Math.floor(Math.random() * max);
      if (idx === exclude) idx = (idx + 1) % max;
      return idx;
    }

    // Set quote with optional animation
    function setQuoteAnimated(text) {
      if (animating) return;
      animating = true;
      
      if (firstRender) {
        quoteText.textContent = text;
        animating = false;
        firstRender = false;
        return;
      }

      quoteText.classList.add('fade-exit');
      quoteText.offsetHeight;
      quoteText.classList.add('fade-exit-active');
      
      setTimeout(() => {
        quoteText.classList.remove('fade-exit', 'fade-exit-active');
        quoteText.textContent = text;
        quoteText.classList.add('fade-enter');
        quoteText.offsetHeight;
        quoteText.classList.add('fade-enter-active');
        
        setTimeout(() => {
          quoteText.classList.remove('fade-enter', 'fade-enter-active');
          animating = false;
        }, 380);
      }, 180);
    }

    function showRandomQuote() {
      const quotes = currentLanguage === 'uk' ? translations_quotes_uk : translations_quotes_en;
      const idx = randomIndexExcluding(quotes.length, currentIndex);
      currentIndex = idx;
      setQuoteAnimated(quotes[idx]);
    }

    async function copyQuote() {
      const text = quoteText.textContent;
      if (!text) return;
      
      try {
        await navigator.clipboard.writeText(text);
        const original = copyBtn.textContent;
        const texts = currentLanguage === 'uk' ? translations_uk : translations_en;
        copyBtn.textContent = texts.copied || 'Copied!';
        setTimeout(() => { 
          copyBtn.textContent = original; 
        }, 1200);
      } catch (e) {
        const texts = currentLanguage === 'uk' ? translations_uk : translations_en;
        prompt(texts.copy || 'Copy', text);
      }
    }

    function onKey(e) {
      if (e.key === 'n' || e.key === 'N') {
        const last = localStorage.getItem(ROLL_KEY);
        if (last === todayStr() && !ADVICE_UNLOCK_ONCE) return; // locked for today unless admin unlock
        newBtn.click();
      }
    }

    function createSparkleBurst() {
      const card = document.getElementById('adviceCard');
      if (!card) return;
      
      const rect = card.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      
      const particleCount = 60; // –ë—ñ–ª—å—à–µ —á–∞—Å—Ç–∏–Ω–æ–∫ –¥–ª—è –≥—É—Å—Ç—ñ—à–æ–≥–æ –¥–∏–º—É
      
      // –ü–∞–ª—ñ—Ç—Ä–∞ –∫–æ–ª—å–æ—Ä—ñ–≤ –¥–ª—è –ø–µ—Ä–µ–ª–∏–≤–∞–Ω–Ω—è
      const colorPalette = [
        ['rgba(139,92,246,0.8)', 'rgba(139,92,246,0.6)', 'rgba(139,92,246,0.4)'], // —Ñ—ñ–æ–ª–µ—Ç–æ–≤–∏–π
        ['rgba(59,130,246,0.8)', 'rgba(59,130,246,0.6)', 'rgba(59,130,246,0.4)'], // —Å–∏–Ω—ñ–π
        ['rgba(147,51,234,0.8)', 'rgba(147,51,234,0.6)', 'rgba(147,51,234,0.4)'], // —Ç–µ–º–Ω–æ-—Ñ—ñ–æ–ª–µ—Ç–æ–≤–∏–π
        ['rgba(168,85,247,0.8)', 'rgba(168,85,247,0.6)', 'rgba(168,85,247,0.4)'], // —Å–≤—ñ—Ç–ª–æ-—Ñ—ñ–æ–ª–µ—Ç–æ–≤–∏–π
        ['rgba(79,70,229,0.8)', 'rgba(79,70,229,0.6)', 'rgba(79,70,229,0.4)'], // —ñ–Ω–¥–∏–≥–æ
        ['rgba(219,39,119,0.8)', 'rgba(219,39,119,0.6)', 'rgba(219,39,119,0.4)']  // —Ä–æ–∂–µ–≤–∏–π
      ];
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'sparkle-particle';
        
        const angle = (Math.PI * 2 * i) / particleCount;
        const distance = 150 + Math.random() * 150; // –ë—ñ–ª—å—à–∞ –æ–±–ª–∞—Å—Ç—å
        const tx = Math.cos(angle) * distance;
        const ty = Math.sin(angle) * distance;
        
        // –í–∏–ø–∞–¥–∫–æ–≤–∏–π –∫–æ–ª—ñ—Ä –∑ –ø–∞–ª—ñ—Ç—Ä–∏
        const colors = colorPalette[Math.floor(Math.random() * colorPalette.length)];
        
        particle.style.left = centerX + 'px';
        particle.style.top = centerY + 'px';
        particle.style.setProperty('--tx', tx + 'px');
        particle.style.setProperty('--ty', ty + 'px');
        particle.style.setProperty('--particle-color-1', colors[0]);
        particle.style.setProperty('--particle-color-2', colors[1]);
        particle.style.setProperty('--particle-color-3', colors[2]);
        
        // –í–∏–ø–∞–¥–∫–æ–≤–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –µ—Ñ–µ–∫—Ç—É –ø–µ—Ä–µ–ª–∏–≤–∞–Ω–Ω—è
        particle.style.animationDelay = (Math.random() * 0.2) + 's';
        
        document.body.appendChild(particle);
        
        setTimeout(() => particle.remove(), 3300);
      }
    }

    // Event listeners
    newBtn.addEventListener('click', () => {
      const last = localStorage.getItem(ROLL_KEY);
      const today = todayStr();
      
      // Allow one extra roll if admin unlocked it
      if (last === today && !ADVICE_UNLOCK_ONCE) { 
        setRollDisabled(true); 
        return; 
      }
      
      // Create sparkle burst effect
      createSparkleBurst();
      
      // Get the selected quote BEFORE animation
      const quotes = currentLanguage === 'uk' ? translations_quotes_uk : translations_quotes_en;
      const idx = randomIndexExcluding(quotes.length, currentIndex);
      currentIndex = idx;
      const selectedQuote = quotes[idx];
      
      // Show animation
      setQuoteAnimated(selectedQuote);
      
      // Save to localStorage after animation completes
      setTimeout(() => {
        try {
          localStorage.setItem(ROLL_KEY, today);
          localStorage.setItem(QUOTE_OF_DAY_KEY, selectedQuote);
          console.log('Saved:', {date: today, quote: selectedQuote}); // Debug
        } catch(e) { console.error('localStorage error:', e); }
        setRollDisabled(true);
        // –û–¥–Ω–æ—Ä–∞–∑–æ–≤–µ —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–µ ‚Äî –≤–∏–º–∏–∫–∞—î–º–æ, —â–æ–± –±—ñ–ª—å—à–µ –Ω–µ –æ–±—Ö–æ–¥–∏—Ç–∏ –ª—ñ–º—ñ—Ç
        if (ADVICE_UNLOCK_ONCE) {
          ADVICE_UNLOCK_ONCE = false;
        }
        updateSaveButton();
      }, 600);
    });

    copyBtn.addEventListener('click', copyQuote);

    if (saveBtn) {
      saveBtn.addEventListener('click', () => {
        const text = quoteText.textContent;
        if (!text) return;
  const items = loadFavorites();
  const idx = items.findIndex(it => it && it.text === text);
        const wasEmpty = items.length === 0;

        if (idx === -1) {
          // ensure we store objects with a favorite flag
          items.unshift({ text, favorite: true });
          saveFavorites(items);
          updateSaveButton();

          // If this is the first saved quote, set it as the daily quote (persist locally)
          if (wasEmpty) {
            try {
              const today = new Date().toISOString().slice(0,10);
              localStorage.setItem('dailyMoodDailyQuote', text);
              localStorage.setItem('dailyMoodDailyQuoteDate', today);
              const dq = document.getElementById('dailyQuoteText');
              const da = document.getElementById('dailyQuoteAuthor');
              if (dq) dq.textContent = text;
              if (da) da.textContent = '';
            } catch (e) {
              console.warn('Could not persist daily quote', e);
            }
          }
          // Notify other pages that favorites changed
          try { window.dispatchEvent(new Event('favoritesUpdated')); } catch(e){}
        } else {
          // if already saved, remove it entirely
          items.splice(idx, 1);
          saveFavorites(items);
          updateSaveButton();
          try { window.dispatchEvent(new Event('favoritesUpdated')); } catch(e){}
        }
      });
    }

    window.addEventListener('keydown', onKey);

    // Language change handler
    window.addEventListener('languageChanged', () => {
      // Update button texts
      const texts = currentLanguage === 'uk' ? translations_uk : translations_en;
      if (newBtn) setRollDisabled(newBtn.disabled);
      if (copyBtn) copyBtn.textContent = texts.copy_quote || '–ö–æ–ø—ñ—é–≤–∞—Ç–∏';
      if (saveBtn) updateSaveButton();

      // Show new quote without animation, respecting daily lock
      firstRender = true;
      const last = localStorage.getItem(ROLL_KEY);
      const today = todayStr();
      const stored = localStorage.getItem(QUOTE_OF_DAY_KEY);
      if (last === today && stored) {
        setQuoteAnimated(stored);
        setRollDisabled(!ADVICE_UNLOCK_ONCE);
      } else {
        showRandomQuote();
        setRollDisabled(false);
      }
      setTimeout(updateSaveButton, 60);
    });

    // Initialize (respect daily lock and restore today's quote)
    (function initDailyQuote(){
      const last = localStorage.getItem(ROLL_KEY);
      const today = todayStr();
      const stored = localStorage.getItem(QUOTE_OF_DAY_KEY);
      console.log('Init check:', {last, today, stored}); // Debug log
      if (last === today && stored) {
        firstRender = true;
        setQuoteAnimated(stored);
        setRollDisabled(!ADVICE_UNLOCK_ONCE);
      } else {
        showRandomQuote();
        setRollDisabled(false);
      }
      setTimeout(updateSaveButton, 300);
    })();

    // -------------------- Activity Recommendations (Premium) --------------------
    (async function initActivityRecs() {
      const section = document.getElementById('activityRecsSection');
      const content = document.getElementById('recsContent');
      const locked = document.getElementById('recsLocked');
      const errorEl = document.getElementById('recsError');
      
      if (!section) return;
      
      try {
        // Check if user is logged in and premium
        const userRes = await fetch('/api/me', { credentials: 'include' });
        if (!userRes.ok) {
          // Not logged in - hide section
          return;
        }
        
        const userData = await userRes.json();
        const user = userData.user || {};
        
        section.style.display = '';
        
        if (!user.is_premium) {
          // Show locked state
          locked.style.display = '';
          content.style.display = 'none';
          return;
        }
        
        // Premium user - fetch recommendations
        const recsRes = await fetch('/api/premium/activity-recommendations', { credentials: 'include' });
        
        if (!recsRes.ok) {
          throw new Error('Failed to load recommendations');
        }
        
        const data = await recsRes.json();
        
        if (data.status === 'success') {
          locked.style.display = 'none';
          content.style.display = '';
          
          // Set title
          document.getElementById('recsMoodTitle').textContent = (data.mood_emoji || '') + ' ' + (data.title || '');
          
          // Render activities
          const activitiesEl = document.getElementById('recsActivities');
          activitiesEl.innerHTML = '';
          
          if (data.activities && data.activities.length) {
            data.activities.forEach(activity => {
              const card = document.createElement('div');
              card.style.cssText = 'background:rgba(255,255,255,0.03); padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.1);';
              card.innerHTML = `
                <div style="display:flex; gap:10px; align-items:start;">
                  <div style="font-size:1.8em; line-height:1;">${activity.icon || '‚Ä¢'}</div>
                  <div style="flex:1;">
                    <div style="font-weight:700; margin-bottom:4px;">${activity.name || ''}</div>
                    <div style="opacity:0.8; font-size:0.9em; margin-bottom:4px;">${activity.description || ''}</div>
                    <div class="muted" style="font-size:0.85em;">${activity.duration || ''}</div>
                  </div>
                </div>
              `;
              activitiesEl.appendChild(card);
            });
          }
          
          // Set tip
          if (data.tip) {
            document.getElementById('recsTip').innerHTML = `<strong>üí° –ü–æ—Ä–∞–¥–∞:</strong> ${data.tip}`;
          }
        } else {
          throw new Error(data.message || 'Unknown error');
        }
        
      } catch (err) {
        console.error('Activity Recommendations error:', err);
        if (errorEl) {
          errorEl.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.';
          errorEl.style.display = 'block';
        }
      }
    })();
  })();
</script>
{% endblock %}