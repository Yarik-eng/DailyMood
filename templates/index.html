{% extends "base.html" %}

{% block title %}DailyMood — Home{% endblock %}

{% block content %}
<div class="quote-wrap">
  <div class="card">
    <div class="quote-inner">
        <p id="quoteText">&nbsp;</p>
      </div>
  </div>
  <div class="controls">
    <button id="newQuote" class="btn secondary" data-i18n="new_quote">Нова цитата</button>
    <button id="copyQuote" class="btn secondary" data-i18n="copy_quote">Копіювати</button>
    <button id="saveQuote" class="btn secondary" data-i18n="save_quote">Зберегти</button>
  </div>
  <p class="muted"><small data-i18n="tip_new_quote">Підказка: Натисніть N для нової цитати</small></p>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  (function () {
    // Get quotes based on current language
    const QUOTES = currentLanguage === 'uk' ? translations_quotes_uk : translations_quotes_en;

    const quoteText = document.getElementById('quoteText');
    const newBtn = document.getElementById('newQuote');
    const copyBtn = document.getElementById('copyQuote');
    const saveBtn = document.getElementById('saveQuote');

    let currentIndex = -1;
    let animating = false;
    let firstRender = true;

    // Favorites (localStorage)
    const FAVORITES_KEY = 'dailyMoodFavorites';
    function loadFavorites() { 
      try {
        const raw = JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
        if (!Array.isArray(raw)) return [];
        return raw.map(item => {
          if (typeof item === 'string') return { text: item, favorite: false };
          if (item && typeof item === 'object' && 'text' in item) return { text: String(item.text), favorite: !!item.favorite };
          return null;
        }).filter(Boolean);
      } catch(e) { return []; }
    }
    function saveFavorites(arr) { try { localStorage.setItem(FAVORITES_KEY, JSON.stringify(arr)); } catch(e) {} }
    function isCurrentSaved() { const items = loadFavorites(); return items.some(it => it.text === quoteText.textContent); }
  function updateSaveButton() { if (!saveBtn) return; const texts = currentLanguage === 'uk' ? translations_uk : translations_en; saveBtn.textContent = isCurrentSaved() ? (texts.saved_quote || 'Saved') : (texts.save_quote || 'Save'); }

    function randomIndexExcluding(max, exclude) {
      if (max <= 1) return 0;
      let idx = Math.floor(Math.random() * max);
      if (idx === exclude) idx = (idx + 1) % max;
      return idx;
    }

    // Set quote with optional animation
    function setQuoteAnimated(text) {
      if (animating) return;
      animating = true;
      
      if (firstRender) {
        quoteText.textContent = text;
        animating = false;
        firstRender = false;
        return;
      }

      quoteText.classList.add('fade-exit');
      quoteText.offsetHeight;
      quoteText.classList.add('fade-exit-active');
      
      setTimeout(() => {
        quoteText.classList.remove('fade-exit', 'fade-exit-active');
        quoteText.textContent = text;
        quoteText.classList.add('fade-enter');
        quoteText.offsetHeight;
        quoteText.classList.add('fade-enter-active');
        
        setTimeout(() => {
          quoteText.classList.remove('fade-enter', 'fade-enter-active');
          animating = false;
        }, 380);
      }, 180);
    }

    function showRandomQuote() {
      const quotes = currentLanguage === 'uk' ? translations_quotes_uk : translations_quotes_en;
      const idx = randomIndexExcluding(quotes.length, currentIndex);
      currentIndex = idx;
      setQuoteAnimated(quotes[idx]);
    }

    async function copyQuote() {
      const text = quoteText.textContent;
      if (!text) return;
      
      try {
        await navigator.clipboard.writeText(text);
        const original = copyBtn.textContent;
        const texts = currentLanguage === 'uk' ? translations_uk : translations_en;
        copyBtn.textContent = texts.copied || 'Copied!';
        setTimeout(() => { 
          copyBtn.textContent = original; 
        }, 1200);
      } catch (e) {
        const texts = currentLanguage === 'uk' ? translations_uk : translations_en;
        prompt(texts.copy || 'Copy', text);
      }
    }

    function onKey(e) {
      if (e.key === 'n' || e.key === 'N') showRandomQuote();
    }

    // Event listeners
    newBtn.addEventListener('click', () => {
      showRandomQuote();
      setTimeout(updateSaveButton, 350);
    });

    copyBtn.addEventListener('click', copyQuote);

    if (saveBtn) {
      saveBtn.addEventListener('click', () => {
        const text = quoteText.textContent;
        if (!text) return;
  const items = loadFavorites();
  const idx = items.findIndex(it => it && it.text === text);
        const wasEmpty = items.length === 0;

        if (idx === -1) {
          // ensure we store objects with a favorite flag
          items.unshift({ text, favorite: true });
          saveFavorites(items);
          updateSaveButton();

          // If this is the first saved quote, set it as the daily quote (persist locally)
          if (wasEmpty) {
            try {
              const today = new Date().toISOString().slice(0,10);
              localStorage.setItem('dailyMoodDailyQuote', text);
              localStorage.setItem('dailyMoodDailyQuoteDate', today);
              const dq = document.getElementById('dailyQuoteText');
              const da = document.getElementById('dailyQuoteAuthor');
              if (dq) dq.textContent = text;
              if (da) da.textContent = '';
            } catch (e) {
              console.warn('Could not persist daily quote', e);
            }
          }
          // Notify other pages that favorites changed
          try { window.dispatchEvent(new Event('favoritesUpdated')); } catch(e){}
        } else {
          // if already saved, remove it entirely
          items.splice(idx, 1);
          saveFavorites(items);
          updateSaveButton();
          try { window.dispatchEvent(new Event('favoritesUpdated')); } catch(e){}
        }
      });
    }

    window.addEventListener('keydown', onKey);

    // Language change handler
    window.addEventListener('languageChanged', () => {
      // Update button texts
      const texts = currentLanguage === 'uk' ? translations_uk : translations_en;
      if (newBtn) newBtn.textContent = texts.new_quote || 'New Quote';
      if (copyBtn) copyBtn.textContent = texts.copy_quote || 'Copy';
      if (saveBtn) updateSaveButton();

      // Show new quote without animation
      firstRender = true;
      showRandomQuote();
      setTimeout(updateSaveButton, 60);
    });

    // Initialize
    showRandomQuote();
    setTimeout(updateSaveButton, 300);
  })();
</script>
{% endblock %}